{% extends "base.html" %}
{% load static %}
{% load calibration_filters %}

{% block title %}{{ calibration.name }} - {{ wall.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">{{ calibration.name }}</h1>
        <div class="space-x-4">
            <a href="{% url 'wall_calibration_list' wall.pk %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                Back to Calibrations
            </a>
            <a href="{% url 'calibration_create' wall.pk %}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                Create New
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Calibration Details -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Calibration Details</h2>
            
            <div class="space-y-4">
                <div>
                    <span class="font-medium">Wall:</span>
                    <a href="{% url 'wall_detail' wall.uuid %}" class="text-blue-600 hover:text-blue-900 ml-2">
                        {{ wall.name }}
                    </a>
                </div>
                
                <div>
                    <span class="font-medium">Status:</span>
                    {% if calibration.is_active %}
                        <span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Active
                        </span>
                    {% else %}
                        <span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            Inactive
                        </span>
                    {% endif %}
                </div>
                
                <div>
                    <span class="font-medium">Created:</span>
                    <span class="ml-2">{{ calibration.created|date:"Y-m-d H:i:s" }}</span>
                </div>
                
                <div>
                    <span class="font-medium">Reprojection Error:</span>
                    <span class="ml-2">
                        {% if calibration.reprojection_error %}
                            {{ calibration.reprojection_error|floatformat:2 }} pixels
                        {% else %}
                            Not calculated
                        {% endif %}
                    </span>
                </div>
                
                <div>
                    <span class="font-medium">ArUco Dictionary:</span>
                    <span class="ml-2">{{ calibration.aruco_dictionary }}</span>
                </div>
                
                <div>
                    <span class="font-medium">Marker Size:</span>
                    <span class="ml-2">{{ calibration.marker_size_meters }} meters</span>
                </div>
                
                {% if calibration.description %}
                <div>
                    <span class="font-medium">Description:</span>
                    <p class="mt-2 text-gray-600">{{ calibration.description }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Calibration Image -->
            {% if calibration.calibration_image %}
            <div class="mt-6">
                <h3 class="text-lg font-medium mb-2">Calibration Image</h3>
                <img src="{{ calibration.calibration_image.url }}" alt="Calibration reference image" 
                     class="max-w-full h-auto rounded border border-gray-300">
            </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="mt-6 flex space-x-4">
                {% if not calibration.is_active %}
                    <form method="post" action="{% url 'calibration_activate' wall.pk calibration.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            Activate Calibration
                        </button>
                    </form>
                {% endif %}
                
                <form method="post" action="{% url 'calibration_delete' wall.pk calibration.pk %}"
                      onsubmit="return confirm('Are you sure you want to delete this calibration?')">
                    {% csrf_token %}
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                        Delete Calibration
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Technical Details -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Technical Details</h2>
            
            <!-- ArUco Markers -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-2">ArUco Markers ({{ calibration.aruco_markers|length }})</h3>
                <div class="bg-gray-100 p-4 rounded max-h-48 overflow-y-auto">
                    {% for marker_id, marker_data in calibration.aruco_markers.items %}
                    <div class="mb-2 pb-2 border-b border-gray-300 last:border-b-0">
                        <span class="font-medium">Marker {{ marker_id }}:</span>
                        {% if marker_data.type == 'rect' %}
                            <span class="text-sm text-gray-600 ml-2">
                                Rect ({{ marker_data.x }}, {{ marker_data.y }}) - {{ marker_data.width }}x{{ marker_data.height }}
                            </span>
                        {% elif marker_data.type == 'circle' %}
                            <span class="text-sm text-gray-600 ml-2">
                                Circle ({{ marker_data.cx }}, {{ marker_data.cy }}) - r={{ marker_data.r }}
                            </span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Camera Matrix -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-2">Camera Matrix</h3>
                <div class="bg-gray-100 p-4 rounded font-mono text-sm">
                    {% for row in calibration.camera_matrix %}
                    [{{ row|join:", " }}]<br>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Perspective Transform -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-2">Perspective Transform Matrix</h3>
                <div class="bg-gray-100 p-4 rounded font-mono text-sm">
                    {% for row in calibration.perspective_transform %}
                    [{{ row|join:", " }}]<br>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Distortion Coefficients -->
            <div>
                <h3 class="text-lg font-medium mb-2">Distortion Coefficients</h3>
                <div class="bg-gray-100 p-4 rounded font-mono text-sm">
                    [{{ calibration.distortion_coeffs|join:", " }}]
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calibration Visualization -->
    <div class="mt-8 bg-white shadow-md rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Calibration Visualization</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- SVG Preview -->
            <div>
                <h3 class="text-lg font-medium mb-2">Wall Layout (SVG)</h3>
                {% if wall.svg_file %}
                <div class="bg-gray-100 p-4 rounded border border-gray-300">
                    <img src="{{ wall.svg_file.url }}" alt="Wall SVG" class="max-w-full h-auto">
                </div>
                {% else %}
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4">
                    <p class="font-bold">No SVG File</p>
                    <p>No SVG file associated with this wall.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Transformed SVG Overlay -->
            {% if calibration.overlay_image %}
            <div>
                <h3 class="text-lg font-medium mb-2">Transformed SVG Overlay</h3>
                <div class="bg-gray-100 p-4 rounded border border-gray-300 relative overflow-hidden">
                    <img src="{{ calibration.overlay_image.url }}" alt="Transformed SVG Overlay" class="max-w-full h-auto">
                </div>
            </div>
            {% else %}
            <div>
                <h3 class="text-lg font-medium mb-2">Transformed SVG Overlay</h3>
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4">
                    <p class="font-bold">Overlay Not Available</p>
                    <p>The overlay image is being generated or has failed. Please check back later.</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Coordinate Mapping Info -->
            <div>
                <h3 class="text-lg font-medium mb-2">Coordinate Mapping</h3>
                <div class="bg-gray-100 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-2">
                        This calibration maps camera coordinates to SVG coordinates using the detected ArUco markers.
                    </p>
                    <p class="text-sm text-gray-600 mb-2">
                        <strong>Wall Dimensions:</strong> {{ wall.width_mm }}mm Ã— {{ wall.height_mm }}mm
                    </p>
                    <p class="text-sm text-gray-600">
                        <strong>Active:</strong> This calibration can be used for touch detection and pose tracking.
                    </p>
                    
                    {% if calibration.is_active %}
                    <div class="mt-4 p-3 bg-green-100 border-l-4 border-green-500 text-green-700">
                        <p class="font-medium">This calibration is currently active</p>
                        <p class="text-sm">It will be used for pose detection and touch tracking on this wall.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
